# Tasks — Spectre CLI Unification

*Generated by create_tasks on 2025-01-08*

## Objective

Migrate subspace-cli into the spectre repo, rename all references from "subspace" to "spectre", and create a unified CLI with `spectre build`, `spectre subagent`, `spectre command`, and `spectre setup` commands.

## Scope

- **In Scope**:
  - Port subspace-cli code into spectre repo
  - Rename all "subspace" → "spectre" references
  - Create unified CLI entry point with subcommands
  - Restructure as monorepo (cli/, plugins/, agents/)
  - Move existing commands/agents/hooks into plugins/spectre/
  - Create setup command for plugin linking
  - Update pyproject.toml with new structure

- **Out of Scope**:
  - New features beyond migration
  - Memory plugin implementation (separate task)
  - Publishing to any registry
  - Windows compatibility

## Requirements Traced

| ID | Description | Source | Tasks |
|----|-------------|--------|-------|
| REQ-001 | Rename all "subspace" → "spectre" | User request | 2.1, 2.2 |
| REQ-002 | Unified CLI entry point | User request | 2.3 |
| REQ-003 | `spectre build` command | Existing code | 1.2 |
| REQ-004 | `spectre subagent` commands | subspace-cli | 2.1 |
| REQ-005 | `spectre command` commands | subspace-cli | 2.2 |
| REQ-006 | `spectre setup` command | User request | 3.1 |
| REQ-007 | Monorepo structure | User request | 1.1 |
| REQ-008 | Move commands to plugin | Restructure | 1.3 |
| REQ-009 | Move agents to plugin | Restructure | 1.3 |
| REQ-010 | Move hooks to plugin | Restructure | 1.3 |
| REQ-011 | Update pyproject.toml | Technical | 4.1 |
| REQ-012 | Shared utilities module | Pattern | 2.4 |
| REQ-013 | Update skill file | Pattern | 3.2 |

---

## Architecture Context

### Where This Fits
- Extends `spectre/` repo from plugin-only to full CLI + plugins monorepo
- Absorbs `subspace-cli/` functionality under the spectre brand
- Entry point: `spectre` CLI with subcommands (build, subagent, command, setup)
- File: `cli/main.py` → routes to `cli/build/`, `cli/subagent/`, `cli/command/`

### Technical Approach
- Click-based CLI with command groups (matching subspace-cli pattern)
- Monorepo with plugins as directories, symlinked during `spectre setup`
- Shared discovery module (`cli/shared/discovery.py`) for agents/commands
- Existing `cli/build.py` refactored into `cli/build/` module

### Key Decisions
- Keep `spectre-build` as alias for backwards compatibility
- Plugins symlinked to `~/.claude/plugins/` (not copied) for live development
- Agents shared between CLI and plugins via common `agents/` directory
- Click over argparse for consistency with subspace-cli patterns

---

## Tasks

### Phase 1: Repository Restructure

#### [x] [1.1] Create Monorepo Directory Structure
- [x] **1.1.1** Create new directory layout for unified repo
  - [x] `cli/` directory with `__init__.py` created
  - [x] `cli/build/`, `cli/subagent/`, `cli/command/`, `cli/shared/` subdirectories created
  - [x] `plugins/` directory with `spectre/` and `shared/` subdirectories created
  - [x] `agents/` directory at repo root created
  - [x] `templates/` directory with agent.md, command.md templates created

#### [x] [1.2] Refactor build.py into cli/build/ Module
- [x] **1.2.1** Split current `cli/build.py` into modular structure
  - [x] `cli/build/__init__.py` exposes main entry point
  - [x] `cli/build/loop.py` contains main build loop logic
  - [x] `cli/build/prompt.py` contains PROMPT_TEMPLATE and build_prompt()
  - [x] `cli/build/stats.py` contains BuildStats class
  - [x] `cli/build/stream.py` contains stream-json parsing functions

- [x] **1.2.2** Update imports and verify build command still works
  - [x] All internal imports updated to new module paths
  - [x] `spectre build --help` displays correctly
  - [x] `spectre build --tasks <file>` executes successfully

#### [x] [1.3] Move Plugin Assets to plugins/spectre/
- [x] **1.3.1** Relocate current commands/ to plugins/spectre/commands/
  - [x] All .md command files moved
  - [x] Directory structure preserved
  - [x] No broken references

- [x] **1.3.2** Relocate current agents/ to plugins/spectre/agents/
  - [x] All .md agent files moved
  - [x] Directory structure preserved

- [x] **1.3.3** Relocate current hooks/ to plugins/spectre/hooks/
  - [x] hooks.json moved
  - [x] scripts/ subdirectory moved with Python files
  - [x] Paths in hooks.json updated if needed

- [x] **1.3.4** Create/update plugins/spectre/plugin.json
  - [x] Valid plugin.json manifest created
  - [x] Commands, agents, hooks paths configured correctly
  - [x] Plugin loads without errors when symlinked

---

### Phase 2: Port subspace-cli Code

#### [x] [2.1] Port Subagent Module
- [x] **2.1.1** Copy subspace-cli subagent code to cli/subagent/
  - [x] `run.py` — single agent execution
  - [x] `list.py` — list available agents
  - [x] `parallel.py` — parallel agent execution
  - [x] `show.py` — show agent details
  - [x] `__init__.py` with Click command group

- [x] **2.1.2** Rename all "subspace" references to "spectre"
  - [x] Module docstrings updated
  - [x] CLI help text updated
  - [x] Error messages updated
  - [x] Any hardcoded paths updated

- [x] **2.1.3** Update imports for new repo structure
  - [x] Discovery imports point to cli/shared/discovery.py
  - [x] Output formatting imports point to cli/shared/output.py (not needed - using click.echo)
  - [x] All relative imports corrected

#### [x] [2.2] Port Command Module
- [x] **2.2.1** Copy subspace-cli command code to cli/command/
  - [x] `get.py` — retrieve command prompt
  - [x] `list.py` — list available commands
  - [x] `show.py` — show command details
  - [x] `__init__.py` with Click command group

- [x] **2.2.2** Rename all "subspace" references to "spectre"
  - [x] Module docstrings updated
  - [x] CLI help text updated
  - [x] Error messages updated

- [x] **2.2.3** Update imports for new repo structure
  - [x] Discovery imports point to cli/shared/
  - [x] All relative imports corrected

#### [x] [2.3] Create Unified CLI Entry Point
- [x] **2.3.1** Create cli/main.py with Click command groups
  - [x] Root `spectre` command group defined
  - [x] `build` subcommand registered
  - [x] `subagent` subcommand group registered
  - [x] `command` subcommand group registered
  - [x] `setup` subcommand registered
  - [x] `--version` flag shows version

- [x] **2.3.2** Verify all subcommands accessible
  - [x] `spectre --help` shows all subcommands
  - [x] `spectre build --help` works
  - [x] `spectre subagent --help` shows run/list/parallel/show
  - [x] `spectre command --help` shows get/list/show
  - [x] `spectre setup --help` works

#### [x] [2.4] Create Shared Utilities Module
- [x] **2.4.1** Create cli/shared/discovery.py
  - [x] Agent discovery from multiple paths (project, user, plugins)
  - [x] Command discovery from multiple paths
  - [x] Plugin discovery logic
  - [x] Consistent with subspace-cli discovery patterns

- [x] **2.4.2** Create cli/shared/output.py
  - [x] JSON output formatting
  - [x] JSONL streaming output
  - [x] Text/table output formatting
  - [x] Shared across all CLI modules

- [x] **2.4.3** Create cli/shared/config.py
  - [x] Config file loading (~/.spectre/config.yaml or similar)
  - [x] Default paths and settings
  - [x] Environment variable overrides

---

### Phase 3: Setup Command & Skill

#### [x] [3.1] Implement spectre setup Command
- [x] **3.1.1** Create cli/setup.py with plugin linking logic
  - [x] Discovers plugins in repo's plugins/ directory
  - [x] Creates symlinks in ~/.claude/plugins/
  - [x] Handles existing symlinks gracefully (skip or update)
  - [x] Reports what was linked

- [x] **3.1.2** Add agent installation to setup
  - [x] Copies/symlinks agents/ to ~/.claude/agents/
  - [x] Merges with existing agents (no overwrites without flag)
  - [x] Reports what was installed

- [x] **3.1.3** Add skill installation to setup
  - [x] Installs spectre skill to ~/.claude/skills/ or ~/.codex/skills/
  - [x] Skill teaches Claude @agent and /command patterns
  - [x] Uses `spectre` command instead of `subspace`

#### [x] [3.2] Update Skill File for Spectre
- [x] **3.2.1** Create/update skill SKILL.md
  - [x] Pattern recognition for @agent-name syntax
  - [x] Pattern recognition for /command-name syntax
  - [x] Instructions reference `spectre subagent run` and `spectre command get`
  - [x] Examples updated with spectre commands

---

### Phase 4: Package Configuration

#### [x] [4.1] Update pyproject.toml
- [x] **4.1.1** Configure package metadata
  - [x] Package name: `spectre-cli` or `spectre`
  - [x] Version set appropriately
  - [x] Description updated for unified CLI
  - [x] Dependencies include click (if not already)

- [x] **4.1.2** Configure entry points
  - [x] `spectre = "cli.main:main"` as primary entry
  - [x] `spectre-build = "cli.build:main"` as alias for compatibility
  - [x] Package discovery includes cli/ and plugins/

- [x] **4.1.3** Configure package structure
  - [x] `[tool.setuptools.packages.find]` includes cli, plugins
  - [x] Package data includes .md files in plugins/

#### [4.2] Update Installation & README
- [ ] **4.2.1** Test pip install -e . works
  - [ ] All entry points accessible after install
  - [ ] `spectre --help` works
  - [ ] `spectre build`, `spectre subagent`, `spectre command` all work

- [ ] **4.2.2** Update README.md for unified CLI
  - [ ] Installation instructions updated
  - [ ] Usage examples for all commands
  - [ ] Setup instructions (spectre setup)
  - [ ] Plugin development section

---

### Phase 5: Validation & Testing

#### [5.1] Create Test Fixtures
- [ ] **5.1.1** Create minimal test tasks file for build validation
  - [ ] `tests/fixtures/validation_tasks.md` with 1 simple parent task
  - [ ] Task is trivial (e.g., "create a test file") to ensure fast completion
  - [ ] Expected outcome: BUILD_COMPLETE after 1 iteration

- [ ] **5.1.2** Create test agent for subagent validation
  - [ ] `tests/fixtures/test-agent.md` with minimal system prompt
  - [ ] Agent just echoes back a confirmation message
  - [ ] Can be discovered by `spectre subagent list`

#### [5.2] CLI Smoke Tests
- [ ] **5.2.1** Validate all help commands return successfully
  - [ ] `spectre --help` exits 0, shows build/subagent/command/setup
  - [ ] `spectre build --help` exits 0, shows --tasks/--context/--max-iterations
  - [ ] `spectre subagent --help` exits 0, shows run/list/parallel/show
  - [ ] `spectre command --help` exits 0, shows get/list/show
  - [ ] `spectre setup --help` exits 0

- [ ] **5.2.2** Validate version flag
  - [ ] `spectre --version` exits 0, shows version string

#### [5.3] Subagent Validation
- [ ] **5.3.1** Test agent discovery
  - [ ] `spectre subagent list` returns agents from plugins/spectre/agents/
  - [ ] `spectre subagent list --output json` returns valid JSON with agents array
  - [ ] Test agent from fixtures is discoverable

- [ ] **5.3.2** Test agent execution (vanilla mode)
  - [ ] `spectre subagent run "Say 'spectre test passed'"` executes without error
  - [ ] Output contains expected confirmation text
  - [ ] Exit code is 0

- [ ] **5.3.3** Test agent execution (with agent file)
  - [ ] `spectre subagent run test-agent "confirm"` uses test agent
  - [ ] Agent system prompt is applied
  - [ ] Output reflects agent behavior

#### [5.4] Command Validation
- [ ] **5.4.1** Test command discovery
  - [ ] `spectre command list` returns commands from plugins/spectre/commands/
  - [ ] `spectre command list --output json` returns valid JSON with commands array
  - [ ] Known commands (scope, plan, execute) are listed

- [ ] **5.4.2** Test command retrieval
  - [ ] `spectre command get /spectre:scope` returns prompt content
  - [ ] Output contains expected scope-related instructions
  - [ ] Exit code is 0

- [ ] **5.4.3** Test command with arguments
  - [ ] `spectre command get /spectre:scope arg1 arg2` interpolates $1, $2 if present
  - [ ] Arguments are correctly substituted in output

#### [5.5] Build Loop Validation
- [ ] **5.5.1** Test build with validation fixture
  - [ ] `spectre build --tasks tests/fixtures/validation_tasks.md --max-iterations 2`
  - [ ] Build completes with TASK_COMPLETE or BUILD_COMPLETE
  - [ ] Stats dashboard displays at end
  - [ ] Exit code is 0

- [ ] **5.5.2** Test build error handling
  - [ ] `spectre build --tasks nonexistent.md` exits with error
  - [ ] Error message indicates file not found
  - [ ] Exit code is non-zero

#### [5.6] Plugin Validation
- [ ] **5.6.1** Verify plugin symlinks after setup
  - [ ] `spectre setup` creates symlink at ~/.claude/plugins/spectre
  - [ ] Symlink points to correct source directory
  - [ ] `ls -la ~/.claude/plugins/spectre` shows valid link

- [ ] **5.6.2** Verify plugin loads in Claude Code
  - [ ] `echo "list plugins" | claude -p --output-format stream-json --verbose 2>&1`
  - [ ] Init event contains "spectre" in plugins list
  - [ ] No plugin load errors in output

- [ ] **5.6.3** Verify plugin commands accessible
  - [ ] `/spectre:scope` command is recognized by Claude
  - [ ] Plugin agents (@spectre:coder etc.) are available

#### [5.7] Integration Tests (Pattern Recognition)
- [ ] **5.7.1** Test @agent syntax recognition
  - [ ] `echo "use @test-agent to say hello" | claude -p` triggers subagent
  - [ ] Output shows `spectre subagent run` was invoked (or agent executed)
  - [ ] Skill pattern matching works

- [ ] **5.7.2** Test /command syntax recognition
  - [ ] `echo "run /spectre:handoff" | claude -p` triggers command retrieval
  - [ ] Output shows command prompt was fetched and executed
  - [ ] Skill pattern matching works

---

### Phase 6: Cleanup & Deprecation

#### [6.1] Remove Old Structure
- [ ] **6.1.1** Remove old cli/build.py after module refactor verified
  - [ ] Old file deleted
  - [ ] No remaining imports reference old path

- [ ] **6.1.2** Remove old top-level commands/, agents/, hooks/ after plugin move verified
  - [ ] Old directories deleted
  - [ ] Plugin structure verified working

#### [6.2] Delete Old subspace-cli Repo (Optional, Manual)
- [ ] **6.2.1** Delete subspace-cli directory after migration verified
  - [ ] All functionality confirmed working in spectre
  - [ ] `rm -rf /Users/joe/Dev/subspace-cli/` when ready
  - [ ] Internal only — no deprecation notice needed

---

## Execution Strategies

### Sequential Execution

1. **1.1** Create Monorepo Directory Structure (no dependencies)
2. **1.2** Refactor build.py into cli/build/ (depends on 1.1)
3. **1.3** Move Plugin Assets (depends on 1.1)
4. **2.4** Create Shared Utilities (depends on 1.1)
5. **2.1** Port Subagent Module (depends on 1.1, 2.4)
6. **2.2** Port Command Module (depends on 1.1, 2.4)
7. **2.3** Create Unified CLI Entry Point (depends on 1.2, 2.1, 2.2)
8. **3.1** Implement spectre setup (depends on 1.3)
9. **3.2** Update Skill File (depends on 3.1)
10. **4.1** Update pyproject.toml (depends on 2.3)
11. **4.2** Update Installation & README (depends on 4.1)
12. **5.1** Create Test Fixtures (depends on 1.1)
13. **5.2** CLI Smoke Tests (depends on 4.2)
14. **5.3** Subagent Validation (depends on 2.1, 4.2)
15. **5.4** Command Validation (depends on 2.2, 4.2)
16. **5.5** Build Loop Validation (depends on 1.2, 4.2, 5.1)
17. **5.6** Plugin Validation (depends on 3.1, 4.2)
18. **5.7** Integration Tests (depends on 3.2, 4.2)
19. **6.1** Remove Old Structure (depends on 5.2-5.7 all passing)
20. **6.2** Delete subspace-cli (optional, manual, after all verified)

### Parallel Execution

**Wave 1 (concurrent)**: 1.1
- Foundation — create directory structure first

**Wave 2 (after Wave 1)**: 1.2, 1.3, 2.4, 5.1
- Rationale: All depend only on 1.1, can run concurrently
- 1.2 refactors build, 1.3 moves plugin assets, 2.4 creates shared utils, 5.1 creates test fixtures

**Wave 3 (after Wave 2)**: 2.1, 2.2
- Rationale: Port subagent and command modules, both need 2.4 complete
- Can run concurrently as they're independent modules

**Wave 4 (after Wave 3)**: 2.3, 3.1
- Rationale: 2.3 creates unified CLI (needs 1.2, 2.1, 2.2), 3.1 creates setup (needs 1.3)
- Can run concurrently

**Wave 5 (after Wave 4)**: 3.2, 4.1
- Rationale: 3.2 updates skill (needs 3.1), 4.1 updates pyproject (needs 2.3)
- Can run concurrently

**Wave 6 (after Wave 5)**: 4.2
- Rationale: Update README and test install, needs 4.1

**Wave 7 (after Wave 6)**: 5.2, 5.3, 5.4, 5.5, 5.6, 5.7
- Rationale: All validation tests can run concurrently after install verified
- CLI smoke tests, subagent, command, build, plugin, integration tests

**Wave 8 (after Wave 7 all pass)**: 6.1
- Rationale: Cleanup only after ALL validation passes
- 6.2 (delete subspace-cli) is optional/manual — do whenever confident

---

## Coverage Summary

- **Total Requirements Extracted**: 13
- **Requirements with Task Coverage**: 13 (100%)
- **Phases**: 6
- **Parent Tasks**: 18
- **Sub-tasks**: 43
- **Agent-Executable**: 17/18 (6.2 is optional/manual)
